{% extends 'CaiWebBundle::base.html.twig' %}

{% block body %}
    <form method="post">
        <input id="imagenes" type="file" name="imagenes[]" multiple class="upload-input">
    </form>
    <button  id="upload" class="btn btn-default upload-input">Upload</button>
    <div class="container" id="imagenes">
    </div>
{% endblock %}
{% block javascripts %}
    <script>
        // Gran parte sacado de
        // http://abandon.ie/notebook/simple-file-uploads-using-jquery-ajax
        var files;
        $('input[type=file]').change(prepareUpload);
        $('#upload').click(uploadFiles);

        function prepareUpload(event)
        {
            files = event.target.files;
        }

        function uploadFiles(event)
        {
            $('.upload-input').prop('disabled', true);
            event.stopPropagation(); // Stop stuff happening
            event.preventDefault(); // Totally stop stuff happening

            // START A LOADING SPINNER HERE

            // Create a formdata object and add the files
            var data ;
            $.each(files, function(key, value)
            {
                data = new FormData();
                data.append(key, value);
                $.ajax({
                    url: '{{ path('uploader_upload') }}?files',
                    type: 'POST',
                    data: data,
                    cache: false,
                    dataType: 'json',
                    processData: false, // Don't process the files
                    contentType: false, // Set content type to false as jQuery will tell the server its a query string request
                    success: function(data, textStatus, jqXHR)
                    {
                        if(typeof data.error === 'undefined')
                        {
                            // Success so call function to process the form
                            console.log(data);
                            addImagen(data['imagenes'][0]['filenamebinary'],data['imagenes'][0]['filename']);
                            submitForm(event, data);
                        }
                        else
                        {
                            // Handle errors here
                            console.log('ERRORS: ' + data.error);
                        }
                    }
                });
            });

            function submitForm(event, data)
            {
                // Create a jQuery object from the form
                $form = $(event.target);

                // Serialize the form data
                var formData = $form.serialize();

                // You should sterilise the file names
                $.each(data.files, function(key, value)
                {
                    formData = formData + '&filenames[]=' + value;
                });

                $.ajax({
                    url: '{{ path('uploader_upload') }}',
                    type: 'POST',
                    data: formData,
                    cache: false,
                    dataType: 'json',
                    success: function(data, textStatus, jqXHR)
                    {
                        if(typeof data.error === 'undefined')
                        {
                            // Success so call function to process the form
                            console.log('SUCCESS: ' + data.success);
                        }
                        else
                        {
                            // Handle errors here
                            console.log('ERRORS: ' + data.error);
                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown)
                    {
                        // Handle errors here
                        console.log('ERRORS: ' + textStatus);
                    },
                    complete: function()
                    {
                        $('.upload-input').prop('disabled', false);
                        $('input[type=file]').val('');
                    }
                });
            }
        }

        function addImagen(filenamebinary, filename){
            console.log('{{ asset('uploads/biblioteca/imagenes/') }}'+filenamebinary+'/small-'+filename);
            var imagen = $('<img src="{{ asset('uploads/biblioteca/imagenes/') }}'+filenamebinary+'/small-'+filename+'">');
            $('#imagenes').append(imagen);
        }
    </script>
{% endblock %}